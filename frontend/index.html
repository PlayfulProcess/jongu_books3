<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>JonguBooks - Story Creation for Mindful Parents</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html {
      scroll-behavior: smooth;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: #faf9f7;
      color: #2d3748;
      line-height: 1.6;
      min-height: 100vh;
    }

    /* Enhanced Sidebar with Better Visual Hierarchy */
    .sidebar {
      position: fixed;
      left: 0;
      top: 0;
      width: 260px;
      height: 100vh;
      background: linear-gradient(180deg, #f7fafc 0%, #edf2f7 100%);
      border-right: 1px solid #e2e8f0;
      padding: 2rem 0;
      overflow-y: auto;
      box-shadow: 2px 0 10px rgba(0, 0, 0, 0.03);
    }

    .logo {
      padding: 0 2rem 2rem 2rem;
      border-bottom: 1px solid #e2e8f0;
      margin-bottom: 2rem;
      position: relative;
    }

    .logo h1 {
      font-size: 1.5rem;
      font-weight: 700;
      color: #2d3748;
      margin-bottom: 0.25rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .logo .sparkle {
      animation: sparkle 2s ease-in-out infinite;
    }

    @keyframes sparkle {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.6; transform: scale(0.9); }
    }

    .logo p {
      font-size: 0.875rem;
      color: #718096;
      font-style: italic;
    }

    .nav-section {
      margin-bottom: 2rem;
    }

    .nav-title {
      padding: 0 2rem;
      font-size: 0.75rem;
      font-weight: 600;
      color: #a0aec0;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      margin-bottom: 0.75rem;
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem 2rem;
      color: #4a5568;
      text-decoration: none;
      font-size: 0.875rem;
      transition: all 0.2s ease;
      border-left: 3px solid transparent;
      position: relative;
    }

    .nav-item:hover {
      background: linear-gradient(90deg, #edf2f7 0%, transparent 100%);
      color: #2d3748;
    }

    .nav-item.active {
      background: linear-gradient(90deg, rgba(128, 90, 213, 0.1) 0%, transparent 100%);
      color: #805ad5;
      border-left-color: #805ad5;
      font-weight: 600;
    }

    .upgrade-cta {
      margin: 2rem;
      background: linear-gradient(135deg, #805ad5 0%, #6b46c1 100%);
      color: white;
      border: none;
      padding: 1rem 1.5rem;
      border-radius: 8px;
      font-size: 0.875rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      width: calc(100% - 4rem);
      text-align: center;
      box-shadow: 0 4px 12px rgba(128, 90, 213, 0.2);
    }

    .upgrade-cta:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(128, 90, 213, 0.3);
    }

    /* Enhanced Main Content */
    .main-content {
      margin-left: 260px;
      padding: 3rem 4rem;
      max-width: 1000px;
    }

    /* Progress Bar */
    .progress-bar {
      background: white;
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 3rem;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .progress-bar-title {
      font-size: 0.875rem;
      color: #718096;
      margin-bottom: 0.75rem;
    }

    .progress-steps {
      display: flex;
      justify-content: space-between;
      position: relative;
    }

    .progress-step {
      flex: 1;
      text-align: center;
      position: relative;
      z-index: 1;
    }

    .progress-step-circle {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: #e2e8f0;
      margin: 0 auto 0.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 0.875rem;
      transition: all 0.3s ease;
    }

    .progress-step.completed .progress-step-circle {
      background: #48bb78;
      color: white;
    }

    .progress-step.active .progress-step-circle {
      background: #805ad5;
      color: white;
      box-shadow: 0 0 0 4px rgba(128, 90, 213, 0.2);
    }

    .progress-step-label {
      font-size: 0.75rem;
      color: #718096;
    }

    .progress-line {
      position: absolute;
      top: 20px;
      left: 0;
      right: 0;
      height: 2px;
      background: #e2e8f0;
      z-index: 0;
    }

    .progress-line-fill {
      height: 100%;
      background: linear-gradient(90deg, #48bb78 0%, #805ad5 100%);
      width: 25%;
      transition: width 0.3s ease;
    }

    /* Enhanced Header */
    .header {
      margin-bottom: 3rem;
      animation: fadeInUp 0.6s ease-out;
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .header h1 {
      font-size: 2.5rem;
      font-weight: 700;
      color: #2d3748;
      margin-bottom: 1rem;
      background: linear-gradient(135deg, #2d3748 0%, #805ad5 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .intro-text, .text-lg {
      font-size: 1.125rem;
      color: #4a5568;
      margin-bottom: 2rem;
      line-height: 1.8;
    }

    .intro-text strong {
      color: #2d3748;
    }

    .intro-text em {
      color: #805ad5;
      font-style: normal;
      font-weight: 500;
    }

    /* Enhanced Gift Callout */
    .gift-callout {
      background: linear-gradient(135deg, #faf5ff 0%, #f3e8ff 100%);
      border: 1px solid #e9d8fd;
      border-radius: 16px;
      padding: 2.5rem;
      margin: 2rem 0;
      position: relative;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(128, 90, 213, 0.1);
    }

    .gift-callout::before {
      content: 'üéÅ';
      font-size: 3rem;
      position: absolute;
      top: 1rem;
      right: 1.5rem;
      animation: float 3s ease-in-out infinite;
    }

    @keyframes float {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }
    
    /* Sticky AI Button */
    .sticky-ai-button {
      position: fixed;
      bottom: 2rem;
      right: 2rem;
      background: linear-gradient(135deg, #805ad5 0%, #6b46c1 100%);
      color: white;
      border: none;
      padding: 1rem 1.5rem;
      border-radius: 50px;
      font-size: 0.875rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: 0 4px 12px rgba(128, 90, 213, 0.3);
      z-index: 100;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .sticky-ai-button:hover {
      transform: translateY(-2px) scale(1.05);
      box-shadow: 0 8px 25px rgba(128, 90, 213, 0.4);
    }
    
    /* Enhanced Sections */
    .section {
      margin-bottom: 4rem;
      position: relative;
      padding-top: 2rem; /* padding for scroll spy */
      margin-top: -2rem; /* offset for padding */
      animation: fadeInUp 0.6s ease-out;
      animation-fill-mode: both;
    }

    .section-header {
      display: flex;
      align-items: center;
      margin-bottom: 2rem;
      position: relative;
    }

    .step-number {
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, #805ad5 0%, #6b46c1 100%);
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 1rem;
      margin-right: 1rem;
      box-shadow: 0 4px 12px rgba(128, 90, 213, 0.3);
    }

    .section-title {
      font-size: 1.75rem;
      font-weight: 600;
      color: #2d3748;
    }

    /* Enhanced Character Cards */
    .character-card {
      background: white;
      border: 1px solid #e2e8f0;
      border-radius: 16px;
      padding: 2.5rem;
      margin-bottom: 1.5rem;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      position: relative;
      overflow: hidden;
    }

    .character-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 4px;
      height: 100%;
      background: linear-gradient(180deg, #805ad5 0%, #6b46c1 100%);
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .character-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
    }

    .character-card:hover::before {
      opacity: 1;
    }

    /* Enhanced Form Elements */
    .field-group {
      margin-bottom: 2rem;
    }

    .field-label {
      display: block;
      font-size: 0.875rem;
      font-weight: 600;
      color: #374151;
      margin-bottom: 0.5rem;
    }

    .field-input {
      width: 100%;
      padding: 0.875rem 1.25rem;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 0.875rem;
      background: white;
      transition: all 0.2s ease;
    }

    .field-input:focus {
      outline: none;
      border-color: #805ad5;
      box-shadow: 0 0 0 3px rgba(128, 90, 213, 0.1);
    }

    .field-textarea {
      min-height: 140px;
      resize: vertical;
      font-family: inherit;
    }

    .button-group {
        display: flex;
        gap: 1rem;
    }

    .add-button {
        background: transparent;
        border: 2px dashed #cbd5e0;
        color: #4a5568;
        padding: 1rem;
        border-radius: 12px;
        width: 100%;
        cursor: pointer;
        transition: all 0.2s ease;
        font-weight: 600;
    }

    .add-button:hover {
        border-color: #805ad5;
        background: #faf5ff;
    }

    /* Enhanced Page Container */
    .page-container {
      background: white;
      border: 1px solid #e2e8f0;
      border-radius: 16px;
      padding: 2.5rem;
      margin-bottom: 2rem;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 2.5rem;
      min-height: 350px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      transition: all 0.3s ease;
    }

    .page-container:hover {
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
    }

    .page-number {
      position: absolute;
      top: 1rem;
      left: 1rem;
      background: #805ad5;
      color: white;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 0.875rem;
    }

    /* Enhanced Image Area */
    .image-area {
      background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%);
      border: 2px dashed #cbd5e0;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      flex-direction: column;
      gap: 0.5rem;
    }

    .image-area:hover {
      border-color: #805ad5;
      background: linear-gradient(135deg, #faf5ff 0%, #f3e8ff 100%);
      transform: scale(1.02);
    }

    .image-area.has-image {
      border: none;
    }

    .uploaded-image {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 10px;
    }

    /* Enhanced Buttons */
    .button {
      background: linear-gradient(135deg, #805ad5 0%, #6b46c1 100%);
      color: white;
      border: none;
      padding: 0.875rem 1.75rem;
      border-radius: 8px;
      font-size: 0.875rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      box-shadow: 0 4px 12px rgba(128, 90, 213, 0.2);
    }

    .button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(128, 90, 213, 0.3);
    }

    .button-secondary {
      background: white;
      color: #374151;
      border: 2px solid #e5e7eb;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .button-secondary:hover {
      background: #f9fafb;
      border-color: #d1d5db;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    
    /* Export Options */
    .export-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1.5rem;
      margin: 2rem 0;
    }

    .export-option {
      background: white;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      padding: 2rem;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .export-option:hover {
      border-color: #805ad5;
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
    }

    .export-option-icon {
      font-size: 2.5rem;
      margin-bottom: 1rem;
      display: block;
    }

    .export-option-title {
      font-size: 1rem;
      font-weight: 600;
      color: #2d3748;
      margin-bottom: 0.5rem;
    }

    .export-option-description {
      font-size: 0.875rem;
      color: #718096;
    }

    /* Mobile Responsiveness */
    @media (max-width: 768px) {
      .sidebar {
        transform: translateX(-100%);
        transition: transform 0.3s ease;
        z-index: 1000;
      }
      
      .sidebar.open {
        transform: translateX(0);
      }
      
      .main-content {
        margin-left: 0;
        padding: 2rem 1.5rem;
      }
      
      .form-grid,
      .page-container {
        grid-template-columns: 1fr;
      }
      
      .button-group {
        flex-direction: column;
      }
      
      .mobile-menu-button {
        display: block;
        position: fixed;
        top: 1rem;
        left: 1rem;
        z-index: 1001;
        background: white;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        padding: 0.75rem;
        cursor: pointer;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }
    }

    /* Hidden by default */
    .mobile-menu-button {
      display: none;
    }

    /* Toast Notification */
    .toast {
      position: fixed;
      bottom: 2rem;
      right: 2rem;
      background: #2d3748;
      color: white;
      padding: 1rem 1.5rem;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      transform: translateY(100px);
      opacity: 0;
      transition: all 0.3s ease;
      z-index: 1000;
    }

    .toast.show {
      transform: translateY(0);
      opacity: 1;
    }

    /* AI Chat Popup */
    #open-chat-btn {
      position: fixed;
      bottom: 2rem;
      right: 2rem;
      width: 60px;
      height: 60px;
      background: linear-gradient(135deg, #805ad5 0%, #6b46c1 100%);
      color: white;
      border: none;
      border-radius: 50%;
      font-size: 2rem;
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    #open-chat-btn:hover {
      transform: scale(1.1);
      box-shadow: 0 6px 20px rgba(0,0,0,0.3);
    }

    .ai-chat-popup {
      display: none;
      position: fixed;
      bottom: 6.5rem;
      right: 2rem;
      width: 350px;
      max-height: 500px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 5px 25px rgba(0,0,0,0.2);
      flex-direction: column;
      overflow: hidden;
      z-index: 1000;
      transition: all 0.3s ease;
    }

    .ai-chat-popup.show {
      display: flex;
    }

    .ai-chat-header {
      background: linear-gradient(135deg, #805ad5 0%, #6b46c1 100%);
      color: white;
      padding: 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .ai-chat-header h3 {
      margin: 0;
      font-size: 1rem;
    }
    .ai-chat-header button {
      background: none;
      border: none;
      color: white;
      font-size: 1.5rem;
      cursor: pointer;
      opacity: 0.8;
      transition: opacity 0.2s ease;
    }
    .ai-chat-header button:hover {
      opacity: 1;
    }

    .ai-chat-messages {
      flex-grow: 1;
      padding: 1rem;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .message {
      padding: 0.5rem 1rem;
      border-radius: 18px;
      max-width: 80%;
      line-height: 1.4;
    }
    .message.assistant {
      background-color: #f1f1f1;
      color: #333;
      border-top-left-radius: 4px;
      align-self: flex-start;
    }
    .message.user {
      background-color: #805ad5;
      color: white;
      border-top-right-radius: 4px;
      align-self: flex-end;
    }
     .message.typing {
      font-style: italic;
      color: #718096;
      align-self: flex-start;
    }

    .input-with-button {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }
    .input-with-button .field-input {
      flex-grow: 1;
    }
    .input-with-button .button {
      flex-shrink: 0;
      padding: 0.5rem 1rem;
    }

    .image-preview {
      margin-top: 1rem;
    }
    .image-preview img {
      max-width: 100%;
      border-radius: 8px;
      border: 1px solid #e2e8f0;
    }

    .ai-chat-input-container {
      display: flex;
      padding: 1rem;
      border-top: 1px solid #e2e8f0;
    }
    .ai-chat-input-container input {
      flex-grow: 1;
      border: 1px solid #e2e8f0;
      border-radius: 20px;
      padding: 0.5rem 1rem;
      font-size: 0.875rem;
      margin-right: 0.5rem;
    }
    .ai-chat-input-container button {
      background: #805ad5;
      color: white;
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      font-size: 1rem;
      cursor: pointer;
      transition: background 0.2s ease;
    }
    .ai-chat-input-container button:hover {
      background: #6b46c1;
    }

    .page-container:hover {
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
    }

    .text-area {
      position: relative;
      height: 100%;
    }
    .text-area textarea {
      height: 100%;
      padding-bottom: 4.5rem; /* Space for button */
    }
    .text-area .button {
      position: absolute;
      bottom: 1.5rem;
      right: 1.5rem;
    }
  </style>
</head>
<body>
  <!-- Mobile Menu Button -->
  <button class="mobile-menu-button" onclick="toggleSidebar()">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M3 12h18M3 6h18M3 18h18"></path>
    </svg>
  </button>

  <!-- Enhanced Sidebar -->
  <div class="sidebar" id="sidebar">
    <div class="logo">
      <h1><span class="sparkle">üìñ</span> JonguBooks</h1>
      <p>Stories that shape souls.</p>
    </div>

    <div class="nav-section">
      <div class="nav-title">Create</div>
      <a href="#story-section" class="nav-item active" onclick="setActiveSection(event, 'story')">
        <span>üìù</span> Story Foundation
      </a>
      <a href="#characters-section" class="nav-item" onclick="setActiveSection(event, 'characters')">
        <span>üë•</span> Characters
      </a>
      <a href="#pages-section" class="nav-item" onclick="setActiveSection(event, 'pages')">
        <span>üìÑ</span> Pages & Layout
      </a>
      <a href="#export-section" class="nav-item" onclick="setActiveSection(event, 'export')">
        <span>üíæ</span> Review & Export
      </a>
    </div>

    <div class="nav-section">
      <div class="nav-title">Tools</div>
      <a href="#" class="nav-item" onclick="startOver(event)">
        <span>üîÑ</span> Start Over
      </a>
    </div>

    <button class="upgrade-cta" onclick="window.open('https://www.playfulprocess.com/the-nest-knows-best-bunny-coping-tricks/', '_blank')">‚ú® Upgrade to AI-Powered</button>
  </div>

  <main class="main-content">
    <datalist id="character-types">
      <option value="Young child (learning and growing)"></option>
      <option value="Wise guide (mentor figure)"></option>
      <option value="Animal friend (playful companion)"></option>
      <option value="Magical being (wonder-bringer)"></option>
      <option value="Parent/adult (nurturing figure)"></option>
    </datalist>

    <!-- Progress Bar -->
    <div class="progress-bar">
      <div class="progress-bar-title">Your Story Journey</div>
      <div class="progress-steps">
        <div class="progress-line">
          <div class="progress-line-fill" id="progressFill"></div>
        </div>
        <div class="progress-step active" data-step="story">
          <div class="progress-step-circle">1</div>
          <div class="progress-step-label">Story</div>
        </div>
        <div class="progress-step" data-step="characters">
          <div class="progress-step-circle">2</div>
          <div class="progress-step-label">Characters</div>
        </div>
        <div class="progress-step" data-step="pages">
          <div class="progress-step-circle">3</div>
          <div class="progress-step-label">Pages & Art</div>
        </div>
        <div class="progress-step" data-step="export">
          <div class="progress-step-circle">4</div>
          <div class="progress-step-label">Review & Export</div>
        </div>
      </div>
    </div>

    <!-- Enhanced Header -->
    <header class="header">
      <h1>Create Your Own Children's Story</h1>
      <p class="text-lg text-gray-600 leading-relaxed">
        My <em><strong>PlayfulProcess</strong></em> journey into parenthood invites me to explore new ways of educating my children through stories. In a world where AI makes creation more accessible than ever, I've discovered something profound: <strong>it's often easier to build the exact story my child needs than to search for the perfect book that may not exist.</strong>
      </p>
      
      <div class="gift-callout">
        <p class="intro-text" style="margin-bottom: 1rem;">
          <strong>How it works:</strong> Free users can use our custom GPT+ assistant (link below) to generate story content, then paste it back here to create beautiful books. Paid members get instant AI generation directly within JonguBooks.
        </p>
        <p style="color: #718096; font-size: 0.95rem; margin-top: 1rem;">
          <strong>Not into AI? I get it!</strong> Some days I wake up feeling the same way. JonguBooks works beautifully as a pure creative tool - write your own stories, draw your own illustrations, or use photos. The AI is just an option, not a requirement. Your imagination is the only tool you truly need. üíö
        </p>
        <div class="button-group" style="justify-content: center; margin-top: 1.5rem;">
          <button class="button" onclick="window.open('https://chatgpt.com/g/g-68582fc3c3f481919db280da20d31639-jongubooks-assistant', '_blank')">
            ü§ñ Open JonguBooks GPT+ (Free)
          </button>
          <button class="button button-secondary" onclick="window.open('https://www.playfulprocess.com/the-nest-knows-best-bunny-coping-tricks/', '_blank')">
            ‚ú® Upgrade for Integrated AI
          </button>
        </div>
      </div>
    </header>

    <!-- Step 1: Story Foundation -->
    <section id="story-section" class="section">
      <div class="section-header">
        <div class="step-number">1</div>
        <h2 class="section-title">Build Your Story Foundation</h2>
      </div>
      <div class="field-group">
        <label class="field-label">Story Title</label>
        <input type="text" class="field-input" placeholder="Give your story a memorable title" id="storyTitle">
      </div>
      <div class="field-group">
        <label class="field-label">Core Message or Life Lesson</label>
        <textarea class="field-input field-textarea" placeholder="What do you want your child to learn or feel?" id="coreMessage"></textarea>
      </div>
      <div class="field-group">
        <label class="field-label">Story Outline</label>
        <textarea class="field-input field-textarea" style="min-height: 200px;" placeholder="Write or paste your story outline here..." id="storyOutline"></textarea>
      </div>
      <div class="form-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
        <div class="field-group">
          <label class="field-label">Total Words (Optional)</label>
          <input type="number" class="field-input" placeholder="e.g., 500" id="totalWords">
        </div>
        <div class="field-group">
          <label class="field-label">Number of Pages (Optional)</label>
          <input type="number" class="field-input" placeholder="e.g., 12" id="totalPages">
        </div>
      </div>
      <div class="form-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
        <div class="field-group">
          <label class="field-label">Story Tone</label>
          <select class="field-input" id="storyTone">
            <option>Gentle & Nurturing</option>
            <option>Adventurous & Brave</option>
            <option>Joyful & Playful</option>
            <option>Wise & Teaching</option>
          </select>
        </div>
        <div class="field-group">
          <label class="field-label">Target Age</label>
          <select class="field-input" id="targetAge">
            <option>2-4 years</option>
            <option>4-6 years</option>
            <option>6-8 years</option>
            <option>8-12 years</option>
          </select>
        </div>
      </div>
      <div class="button-group">
        <button class="button" onclick="completeStoryFoundation(event)">
          ü§ñ Use AI to Complete Story Foundation
        </button>
      </div>
    </section>

    <!-- Step 2: Characters -->
    <section id="characters-section" class="section">
      <div class="section-header">
        <div class="step-number">2</div>
        <h2 class="section-title">Define Your Characters</h2>
      </div>
      <div class="button-group">
        <button class="button" onclick="generateCharacters(event)">
          ü§ñ Use AI to Create Characters
        </button>
      </div>
      <div id="charactersContainer">
        <div class="character-card">
          <div class="field-group">
            <label class="field-label">Character Name</label>
            <input type="text" class="field-input" placeholder="e.g., Maya the Mindful Elephant" id="characterName1">
          </div>
          <div class="field-group">
            <label class="field-label">Character Purpose & Personality</label>
            <textarea class="field-input field-textarea" placeholder="What makes this character special? What wisdom do they carry?" id="characterPersonality1"></textarea>
          </div>
          <div class="field-group">
            <label class="field-label">Visual Description for AI</label>
            <textarea class="field-input field-textarea" placeholder="e.g., A small, fluffy bunny with long, floppy ears and a tiny pink nose, wearing a blue waistcoat." id="characterVisualDescription1"></textarea>
          </div>
          <div class="field-group">
            <label class="field-label">Visual Reference (Optional)</label>
            <input type="file" class="field-input" accept="image/*" id="characterImage1" onchange="previewManualImage(this)">
            <div class="image-preview" id="imagePreview1"></div>
          </div>
          <div class="button-group" style="margin-top: 1rem;">
            <button class="button" onclick="generateCharacterImage(this)">üé® Use AI to Create Image</button>
          </div>
        </div>
      </div>
      <button class="add-button" onclick="addCharacter()">+ Add Another Character</button>
    </section>

    <!-- Step 3: Pages & Layout -->
    <section id="pages-section" class="section">
      <div class="section-header">
        <div class="step-number">3</div>
        <h2 class="section-title">Design Your Pages</h2>
      </div>
       <div class="button-group" style="margin-bottom: 2rem;">
        <button class="button" onclick="generatePages(event)">
          ü§ñ Use AI to Create All Pages
        </button>
      </div>
      <div id="pagesContainer">
        <div class="page-container" style="position: relative;">
          <span class="page-number">1</span>
           <div class="page-image-section">
            <div class="image-area" onclick="uploadPageImage(this)">
              <span class="image-placeholder-icon">üé®</span>
              Click to upload image
            </div>
            <div class="field-group" style="margin-top: 1rem;">
                <label class="field-label">Visual Description for AI Image</label>
                <textarea class="field-input field-textarea" placeholder="e.g., A bunny looking at the moon from a hill." id="pageImagePrompt1"></textarea>
            </div>
            <div class="button-group">
                <button class="button" onclick="generatePageImage(this)">üé® Use AI to Create Image</button>
            </div>
          </div>
          <div class="text-area">
            <textarea class="field-input field-textarea" style="height: 100%;" placeholder="Enter your page text here..." id="pageText1"></textarea>
             <button class="button" onclick="generatePageText(this)">üìù Use AI to Create Text</button>
          </div>
        </div>
      </div>
      <button class="add-button" onclick="addPage()">+ Add New Page</button>
    </section>

    <!-- Step 4: Review & Export -->
    <section id="export-section" class="section">
      <div class="section-header">
        <div class="step-number">4</div>
        <h2 class="section-title">Review & Export</h2>
      </div>
      <p class="section-description">
        Preview your story and export it in your preferred format.
      </p>
      <div class="export-grid">
        <div class="export-option" onclick="exportAs('pdf')">
          <span class="export-option-icon">üìÑ</span>
          <h3 class="export-option-title">PDF Book</h3>
          <p class="export-option-description">Print-ready or digital reading</p>
        </div>
        <div class="export-option" onclick="exportAs('ebook')">
          <span class="export-option-icon">üì±</span>
          <h3 class="export-option-title">eBook</h3>
          <p class="export-option-description">For tablets and e-readers</p>
        </div>
        <div class="export-option" onclick="exportAs('share')">
          <span class="export-option-icon">üåç</span>
          <h3 class="export-option-title">Share Online</h3>
          <p class="export-option-description">Get a shareable link</p>
        </div>
      </div>
      <div class="button-group" style="justify-content: center; margin-top: 2rem;">
        <button class="button" onclick="previewBook()">üëÅÔ∏è Preview Book</button>
        <button class="button button-secondary" onclick="startNewStory()">üìñ Create Another Story</button>
      </div>
    </section>
  </main>

  <!-- AI Chat Assistant -->
  <div id="ai-chat-popup" class="ai-chat-popup">
    <div class="ai-chat-header">
      <h3>JonguBooks Assistant</h3>
      <button id="close-chat-btn">&times;</button>
    </div>
    <div class="ai-chat-messages" id="ai-chat-messages">
      <div class="message assistant">Hello! I'm your creative partner. Ask me for story ideas, character names, or anything else you need to build a wonderful book.</div>
    </div>
    <div class="ai-chat-input-container">
      <input type="text" id="ai-chat-input" placeholder="e.g., 'Suggest a story about sharing'">
      <button id="ai-chat-send-btn">‚û§</button>
    </div>
  </div>

  <button id="open-chat-btn" class="open-chat-btn">ü§ñ</button>

  <!-- Toast Notification -->
  <div id="toast" class="toast">
    <span id="toastMessage">Message here</span>
  </div>

  <script>
    // --- Lifecycle ---
    document.addEventListener('DOMContentLoaded', () => {
      // Initialize with empty state
      updateProgress('story');
    });

    // --- Navigation and UI functions ---
    function setActiveSection(event, section) {
      event.preventDefault(); // Stop the default anchor link behavior
      
      // Update navigation active class
      document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.remove('active');
      });
      event.currentTarget.classList.add('active');

      // Scroll to the corresponding section
      const sectionElement = document.getElementById(section + '-section');
      if (sectionElement) {
          sectionElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }

      // Update progress bar
      updateProgress(section);

      // Close sidebar on mobile
      if (window.innerWidth <= 768) {
        document.getElementById('sidebar').classList.remove('open');
      }
    }

    function startOver(event) {
      event.preventDefault();
      if (confirm('Are you sure you want to start over? This will erase all your progress.')) {
        characterCount = 0;
        pageCount = 0;

        // Reset Story Foundation fields
        document.getElementById('storyTitle').value = '';
        document.getElementById('coreMessage').value = '';
        document.getElementById('storyOutline').value = '';
        document.getElementById('totalWords').value = '';
        document.getElementById('totalPages').value = '';
        document.getElementById('storyTone').selectedIndex = 0;
        document.getElementById('targetAge').selectedIndex = 0;

        // Reset Characters section to its initial state
        const charactersContainer = document.getElementById('charactersContainer');
        charactersContainer.innerHTML = '';
        addCharacter(); // Add a single blank card

        // Reset Pages section to its initial state
        const pagesContainer = document.getElementById('pagesContainer');
        pagesContainer.innerHTML = '';
        addPage(); // Add a single blank card

        // Reset navigation to the first step
        document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
        const firstNavItem = document.querySelector('.nav-item[href="#story-section"]');
        if (firstNavItem) {
          firstNavItem.classList.add('active');
          firstNavItem.click()
        }
        updateProgress('story');

        showToast('Project cleared. Ready for a new story!');
      }
    }

    function updateProgress(section) {
      const steps = ['story', 'characters', 'pages', 'export'];
      const currentIndex = steps.indexOf(section);
      
      if (currentIndex === -1) return;
      
      const progressPercent = ((currentIndex) / (steps.length - 1)) * 100;
      document.getElementById('progressFill').style.width = progressPercent + '%';
      
      document.querySelectorAll('.progress-step').forEach((step, index) => {
        step.classList.remove('active', 'completed');
        if (index < currentIndex) {
          step.classList.add('completed');
        } else if (index === currentIndex) {
          step.classList.add('active');
        }
      });
    }

    // --- Toast Notification ---
    function showToast(message) {
      const toast = document.getElementById('toast');
      document.getElementById('toastMessage').textContent = message;
      toast.classList.add('show');
      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    }

    // --- Card management ---
    let characterCount = 0;
    function addCharacter(character = null) {
      characterCount++;
      const container = document.getElementById('charactersContainer');
      const newCard = document.createElement('div');
      newCard.className = 'character-card';
      newCard.innerHTML = `
        <div class="field-group">
            <label class="field-label">Character Name</label>
            <input type="text" class="field-input" placeholder="e.g., Leo the Brave Lion" id="characterName${characterCount}" value="${character ? character.name : ''}">
        </div>
        <div class="field-group">
            <label class="field-label">Character Purpose & Personality</label>
            <textarea class="field-input field-textarea" placeholder="What makes this character special?" id="characterPersonality${characterCount}">${character ? character.personality : ''}</textarea>
        </div>
        <div class="field-group">
            <label class="field-label">Visual Description for AI</label>
            <textarea class="field-input field-textarea" placeholder="e.g., A small, fluffy bunny with long, floppy ears and a tiny pink nose, wearing a blue waistcoat." id="characterVisualDescription${characterCount}"></textarea>
        </div>
        <div class="field-group">
            <label class="field-label">Visual Reference (Optional)</label>
            <input type="file" class="field-input" accept="image/*" id="characterImage${characterCount}" onchange="previewManualImage(this)">
            <div class="image-preview" id="imagePreview${characterCount}"></div>
        </div>
        <div class="button-group" style="margin-top: 1rem;">
            <button class="button" onclick="generateCharacterImage(this)">üé® Use AI to Create Image</button>
        </div>
        <div class="button-group" style="margin-top: 1rem;">
          <button class="button button-secondary" onclick="removeCharacter(this)">üóëÔ∏è Remove</button>
        </div>
      `;
      container.appendChild(newCard);
      if (!character) {
        showToast('New character card added!');
      }
    }

    function removeCharacter(button) {
      if (confirm('Are you sure you want to remove this character?')) {
        button.closest('.character-card').remove();
        showToast('Character removed');
      }
    }

    function previewManualImage(input) {
      const card = input.closest('.character-card');
      const previewContainer = card.querySelector('.image-preview');
      
      if (input.files && input.files[0]) {
          const reader = new FileReader();
          reader.onload = function (e) {
              previewContainer.innerHTML = `<img src="${e.target.result}" alt="Manually uploaded character image">`;
          }
          reader.readAsDataURL(input.files[0]);
      }
    }

    async function generateCharacterImage(button) {
      const card = button.closest('.character-card');
      const visualDescriptionInput = card.querySelector('textarea[id^="characterVisualDescription"]');
      const prompt = visualDescriptionInput.value;

      if (!prompt) {
          showToast('Please provide a visual description for the AI first.');
          return;
      }

      button.disabled = true;
      button.textContent = 'üé® Creating...';

      try {
          const response = await fetch('/api/gpt/generate_image', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ prompt: prompt })
          });
          const result = await response.json();

          if (result.success && result.data.url) {
              const previewContainer = card.querySelector('.image-preview');
              previewContainer.innerHTML = `<img src="${result.data.url}" alt="AI-generated character image">`;
              showToast('AI image created successfully!');
          } else {
              throw new Error(result.detail || 'Failed to generate image.');
          }

      } catch (error) {
          console.error('Error generating image:', error);
          showToast('Error: Could not generate the image.');
      } finally {
          button.disabled = false;
          button.textContent = 'üé® Use AI to Create Image';
      }
    }

    let pageCount = 0;
    function addPage(page = null) {
      pageCount++;
      const container = document.getElementById('pagesContainer');
      const newPage = document.createElement('div');
      newPage.className = 'page-container';
      newPage.style.position = 'relative';
      newPage.innerHTML = `
        <span class="page-number">${pageCount}</span>
        <div class="page-image-section">
            <div class="image-area" onclick="uploadPageImage(this)">
              <span class="image-placeholder-icon">üé®</span>
              Click to upload image
            </div>
            <div class="field-group" style="margin-top: 1rem;">
                <label class="field-label">Visual Description for AI Image</label>
                <textarea class="field-input field-textarea" placeholder="e.g., A bunny looking at the moon from a hill." id="pageImagePrompt${pageCount}">${page && page.illustration_prompt ? page.illustration_prompt : ''}</textarea>
            </div>
            <div class="button-group">
                <button class="button" onclick="generatePageImage(this)">üé® Use AI to Create Image</button>
            </div>
          </div>
        <div class="text-area">
          <textarea class="field-input field-textarea" placeholder="Enter your page text here..." id="pageText${pageCount}">${page ? page.text : ''}</textarea>
           <button class="button" onclick="generatePageText(this)">üìù Use AI to Create Text</button>
        </div>
        <div class="button-group" style="margin-top: 1rem; justify-content: flex-end; width: 100%;">
            <button class="button button-secondary" onclick="removePage(this)">üóëÔ∏è Remove Page</button>
        </div>
      `;
      container.appendChild(newPage);
      if (!page) {
        showToast('New page added!');
      }
    }

    function removePage(button) {
        if(confirm('Are you sure you want to remove this page?')) {
            button.closest('.page-container').remove();
            showToast('Page removed');
        }
    }

    function uploadPageImage(imageArea) {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'image/*';
      input.onchange = function(e) {
        if (e.target.files[0]) {
          const reader = new FileReader();
          reader.onload = function(e) {
            imageArea.innerHTML = `<img src="${e.target.result}" class="uploaded-image" alt="Page illustration">`;
            imageArea.classList.add('has-image');
          };
          reader.readAsDataURL(e.target.files[0]);
        }
      };
      input.click();
    }

    async function generatePageImage(button) {
      showToast("AI image generation for pages coming soon!");
    }

    async function generatePageText(button) {
      const pageContainer = button.closest('.page-container');
      const pageTextarea = pageContainer.querySelector('textarea[id^="pageText"]');
      const pageNumber = parseInt(pageContainer.querySelector('.page-number').textContent);
      
      let previousPageText = '';
      if (pageNumber > 1) {
        const prevPageContainer = pageContainer.previousElementSibling;
        if (prevPageContainer && prevPageContainer.classList.contains('page-container')) {
            const prevTextarea = prevPageContainer.querySelector('textarea[id^="pageText"]');
            if (prevTextarea) {
                previousPageText = prevTextarea.value;
            }
        }
      }

      const requestBody = {
        story_title: document.getElementById('storyTitle').value,
        core_message: document.getElementById('coreMessage').value,
        page_number: pageNumber,
        total_pages: parseInt(document.getElementById('totalPages').value) || 12,
        previous_text: previousPageText,
      };

      if (!requestBody.story_title || !requestBody.core_message) {
        showToast('Please provide a title and core message in Step 1 first.');
        return;
      }

      button.disabled = true;
      button.textContent = 'üìù Writing...';

      try {
        const response = await fetch('/api/gpt/generate_page_text', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(requestBody)
        });
        const result = await response.json();

        if (result.success && result.data.text) {
          pageTextarea.value = result.data.text;
          showToast(`Page ${pageNumber} text generated!`);
        } else {
          throw new Error(result.detail || 'Failed to generate page text.');
        }

      } catch (error) {
        console.error('Error generating page text:', error);
        showToast('Error: Could not generate page text.');
      } finally {
        button.disabled = false;
        button.textContent = 'üìù Use AI to Create Text';
      }
    }

    function previewBook() {
      // Gather all the data from the form first
      const story = {
        title: document.getElementById('storyTitle').value,
        characters: [],
        pages: []
      };

      document.querySelectorAll('#charactersContainer .character-card').forEach(card => {
        const name = card.querySelector(`input[id^="characterName"]`).value;
        if (name) {
          story.characters.push({ name: name });
        }
      });

      document.querySelectorAll('#pagesContainer .page-container').forEach((page, index) => {
        const text = page.querySelector(`textarea[id^="pageText"]`).value;
        const imgSrc = page.querySelector('.uploaded-image')?.src;
        if (text || imgSrc) {
          story.pages.push({
            page_number: index + 1,
            text: text,
            imgSrc: imgSrc
          });
        }
      });

      // --- Generate the HTML for the new tab ---
      let previewHtml = `
        <!DOCTYPE html>
        <html lang="en">
        <head>
          <meta charset="UTF-8">
          <meta name="viewport" content="width=device-width, initial-scale=1.0">
          <title>Preview: ${story.title}</title>
          <style>
            body { font-family: 'Segoe UI', sans-serif; margin: 0; background-color: #f0f0f0; }
            .book-container { max-width: 800px; margin: 2rem auto; }
            .page { background-color: white; padding: 2rem; margin-bottom: 1rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1); display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; min-height: 400px; align-items: center; }
            .page.text-only { grid-template-columns: 1fr; }
            h1 { text-align: center; margin-bottom: 2rem; color: #333; }
            p { font-size: 1.1rem; line-height: 1.8; color: #444; }
            img { max-width: 100%; border-radius: 8px; }
            .page-number { text-align: center; color: #999; margin-top: 1rem; font-style: italic; }
            @media (max-width: 600px) {
              .page { grid-template-columns: 1fr; }
            }
          </style>
        </head>
        <body>
          <div class="book-container">
            <h1>${story.title || 'Untitled Story'}</h1>
      `;
      
      story.pages.forEach(p => {
        const textSide = `<div class="text-content"><p>${p.text.replace(/\n/g, '<br>')}</p></div>`;
        const imageSide = p.imgSrc ? `<div class="image-content"><img src="${p.imgSrc}" alt="Illustration for page ${p.page_number}"></div>` : '';
        
        previewHtml += `
          <div class="page ${!p.imgSrc ? 'text-only' : ''}">
            ${p.imgSrc ? textSide + imageSide : textSide}
          </div>
          <div class="page-number">${p.page_number}</div>
        `;
      });

      previewHtml += `
          </div>
        </body>
        </html>
      `;

      // --- Open the new tab and write the content ---
      const previewWindow = window.open('', '_blank');
      previewWindow.document.open();
      previewWindow.document.write(previewHtml);
      previewWindow.document.close();
    }

    function startNewStory() {
      if (confirm('This will start a new story, but your current work will be saved. Is that okay?')) {
        startOver(new Event('submit'));
      }
    }

    async function generateCharacters(event) {
        event.preventDefault();
        const button = event.currentTarget;
        button.disabled = true;
        button.textContent = 'ü§ñ Thinking...';

        try {
            const storyDetails = {
                title: document.getElementById('storyTitle').value,
                coreMessage: document.getElementById('coreMessage').value,
                age: document.getElementById('targetAge').value,
                tone: document.getElementById('storyTone').value
            };

            if (!storyDetails.title || !storyDetails.coreMessage) {
                showToast('Please provide a title and core message first.');
                return;
            }

            const response = await fetch('/api/gpt/generate_characters', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(storyDetails)
            });

            const result = await response.json();

            if (result.success && result.data) {
                const charactersContainer = document.getElementById('charactersContainer');
                charactersContainer.innerHTML = ''; // Clear existing characters
                result.data.forEach(char => addCharacter(char));
                showToast('AI-generated characters have been added!');
                
                // Navigate to the section
                document.getElementById('characters-section').scrollIntoView({ behavior: 'smooth' });
                updateProgress('characters');
                document.querySelector('.nav-item.active').classList.remove('active');
                document.querySelector('.nav-item[href="#characters-section"]').classList.add('active');

            } else {
                throw new Error(result.detail || 'Failed to generate characters.');
            }
        } catch (error) {
            console.error('Error generating characters:', error);
            showToast('Error: Could not generate characters.');
        } finally {
            button.disabled = false;
            button.textContent = 'ü§ñ Use AI to Create Characters';
        }
    }

    async function generatePages(event) {
      event.preventDefault();
      const button = event.currentTarget;
      button.disabled = true;
      button.textContent = 'ü§ñ Creating all pages...';

      try {
        const storyDetails = {
          story_title: document.getElementById('storyTitle').value,
          core_message: document.getElementById('coreMessage').value,
          total_pages: parseInt(document.getElementById('totalPages').value) || 12,
          age: document.getElementById('targetAge').value,
          tone: document.getElementById('storyTone').value
        };

        if (!storyDetails.story_title || !storyDetails.core_message) {
          showToast('Please provide a title and core message in Step 1 first.');
          return;
        }

        const response = await fetch('/api/gpt/generate_all_pages', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(storyDetails)
        });

        const result = await response.json();

        if (result.success && result.data) {
          const pagesContainer = document.getElementById('pagesContainer');
          pagesContainer.innerHTML = ''; // Clear existing pages
          pageCount = 0; // Reset page count
          
          result.data.forEach(page => {
            addPage({
              page_number: page.page_number,
              text: page.text,
              illustration_prompt: page.illustration_prompt
            });
          });
          
          showToast(`Generated ${result.data.length} pages successfully!`);
          
          // Navigate to the section
          document.getElementById('pages-section').scrollIntoView({ behavior: 'smooth' });
          updateProgress('pages');
          document.querySelector('.nav-item.active').classList.remove('active');
          document.querySelector('.nav-item[href="#pages-section"]').classList.add('active');

        } else {
          throw new Error(result.detail || 'Failed to generate pages.');
        }
      } catch (error) {
        console.error('Error generating pages:', error);
        showToast('Error: Could not generate pages.');
      } finally {
        button.disabled = false;
        button.textContent = 'ü§ñ Use AI to Create All Pages';
      }
    }

    // --- AI Chat ---
    const chatPopup = document.getElementById('ai-chat-popup');
    const openChatBtn = document.getElementById('open-chat-btn');
    const closeChatBtn = document.getElementById('close-chat-btn');
    const chatMessages = document.getElementById('ai-chat-messages');
    const chatInput = document.getElementById('ai-chat-input');
    const sendChatBtn = document.getElementById('ai-chat-send-btn');
    let chatHistory = [];

    openChatBtn.addEventListener('click', () => chatPopup.classList.add('show'));
    closeChatBtn.addEventListener('click', () => chatPopup.classList.remove('show'));

    sendChatBtn.addEventListener('click', sendChatMessage);
    chatInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        sendChatMessage();
      }
    });

    async function sendChatMessage() {
      const messageText = chatInput.value.trim();
      if (!messageText) return;

      // Add user message to UI
      addMessageToChat('user', messageText);
      chatInput.value = '';

      // Add user message to history
      chatHistory.push({ role: 'user', content: messageText });
      
      // Add typing indicator
      const typingIndicator = addMessageToChat('typing', '...');

      try {
        const response = await fetch('/api/ai/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message: messageText, history: chatHistory })
        });
        const result = await response.json();
        
        // Remove typing indicator
        chatMessages.removeChild(typingIndicator);

        if (result.success) {
          addMessageToChat('assistant', result.reply);
          // Add assistant reply to history
          chatHistory.push({ role: 'assistant', content: result.reply });
        } else {
          addMessageToChat('assistant', 'Sorry, I had trouble connecting. Please try again.');
        }
      } catch (error) {
        chatMessages.removeChild(typingIndicator);
        addMessageToChat('assistant', 'Sorry, an error occurred.');
        console.error('Chat error:', error);
      }
    }

    function addMessageToChat(role, text) {
      const messageElement = document.createElement('div');
      messageElement.classList.add('message', role);
      messageElement.textContent = text;
      chatMessages.appendChild(messageElement);
      chatMessages.scrollTop = chatMessages.scrollHeight; // Auto-scroll
      return messageElement;
    }

    async function completeStoryFoundation(event) {
      event.preventDefault();
      const button = event.currentTarget;
      button.disabled = true;
      button.textContent = 'ü§ñ Thinking...';

      try {
        const storyDetails = {
          title: document.getElementById('storyTitle').value,
          coreMessage: document.getElementById('coreMessage').value,
          age: document.getElementById('targetAge').value,
          tone: document.getElementById('storyTone').value
        };

        const response = await fetch('/api/gpt/generate_story_foundation', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(storyDetails)
        });

        const result = await response.json();

        if (result.success && result.data) {
          document.getElementById('storyTitle').value = result.data.title || '';
          document.getElementById('coreMessage').value = result.data.coreMessage || '';
          document.getElementById('storyOutline').value = result.data.outline || '';
          document.getElementById('storyTone').value = result.data.tone || 'Gentle & Nurturing';
          document.getElementById('targetAge').value = result.data.age || '4-6 years';
          showToast('AI has completed the story foundation!');
        } else {
          throw new Error(result.detail || 'Failed to generate story foundation.');
        }
      } catch (error) {
        console.error('Error generating story foundation:', error);
        showToast('Error: Could not complete the story foundation.');
      } finally {
        button.disabled = false;
        button.textContent = 'ü§ñ Use AI to Complete Story Foundation';
      }
    }
  </script>
</body>
</html>